<div class="token-replacement-window">
    {{!-- Custom Header --}}
    <div class="tir-header">
        <div class="tir-header-content">
            <div class="tir-header-icon">
                <img src="{{selectedToken.document.texture.src}}" alt="{{selectedToken.name}}">
            </div>
            <div class="tir-header-title">
                <div class="tir-main-title">{{selectedToken.name}}</div>
                <div class="tir-subtitle">{{selectedToken.actor.type}}</div>
            </div>
        </div>
        <!-- SCANNING PROGRESS -->
        {{#if isScanning}}
            <div class="tir-scan-progress">
                <div class="tir-progress-bar">
                    <div class="tir-progress-fill" style="width: {{scanProgressPercentage}}%"></div>
                    <div class="tir-progress-text">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <span class="tir-progress-total">{{#if scanTotal}}{{scanProgress}} of {{scanTotal}} scanned{{else}}Initializing...{{/if}}</span>
                        | <span class="tir-progress-details">{{scanStatusText}}</span>
                    </div>
                </div>
            </div>
        {{/if}}

    </div>

    <!-- CONTENT -->
    <div class="tir-content">
        {{#if selectedToken}}
            
            <!-- Token Info Header -->
            <div class="tir-token-replacement-header-container">
                <div class="tir-token-replacement-header-left">
                    <i class="fas fa-dice"></i> Available Tokens: {{matches.length}}
                </div>
                <div class="tir-token-replacement-header-right">
                    <button class="button-refresh-cache" title="Refresh Image Cache">
                        <i class="fas fa-sync-alt"></i> Refresh Cache
                    </button>
                </div>
            </div>

            <!-- Image Grid -->
            {{#if hasMatches}}
                <div class="tir-thumbnails-grid">
                    {{#each matches}}
                    {{#if isCacheLoading}}
                    <div class="tir-thumbnail-item tir-status-message">
                        <div class="tir-thumbnail-image">
                            <i class="fas fa-sync-alt fa-spin"></i>
                        </div>
                        <div class="tir-thumbnail-name">{{name}}</div>
                    </div>
                    {{else if isNoCache}}
                    <div class="tir-thumbnail-item tir-status-message">
                        <div class="tir-thumbnail-image">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="tir-thumbnail-name">{{name}}</div>
                    </div>
                    {{else if isNoMatches}}
                    <div class="tir-thumbnail-item tir-status-message">
                        <div class="tir-thumbnail-image">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="tir-thumbnail-name">{{name}}</div>
                    </div>
                    {{else}}
                    <div class="tir-thumbnail-item {{#if isCurrent}}tir-current-image{{/if}}" data-image-path="{{fullPath}}" data-image-name="{{name}}">
                        <div class="tir-thumbnail-image">
                            <img src="{{fullPath}}" alt="{{name}}" loading="lazy">
                            {{#if isCurrent}}
                            <div class="tir-thumbnail-current-badge">
                                <i class="fas fa-check"></i>
                            </div>
                            {{else}}
                            <div class="tir-thumbnail-overlay">
                                <i class="fas fa-check"></i>
                            </div>
                            {{/if}}
                        </div>
                        <div class="tir-thumbnail-name">{{name}}</div>
                    </div>
                    {{/if}}
                    {{/each}}
                </div>
            {{else}}
                <div class="tir-no-matches">
                    <div class="tir-no-matches-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="tir-no-matches-text">
                        <p>No matches found for this token</p>
                        <p>Try refreshing the cache or selecting a different token</p>
                    </div>
                </div>
            {{/if}}
        {{else}}
            <div class="tir-no-token">
                <div class="tir-no-token-icon">
                    <i class="fas fa-user-slash"></i>
                </div>
                <div class="tir-no-token-text">
                    <p>No token selected</p>
                    <p>Select a token on the canvas to view replacement options</p>
                    <button class="tir-button tir-button-primary refresh-detection-btn" style="margin-top: 15px;">
                        <i class="fas fa-sync-alt"></i> Refresh Detection
                    </button>
                </div>
            </div>
        {{/if}}
    </div>
    
    <!-- Footer -->
    <div class="tir-footer">
        <button class="tir-button tir-button-secondary close-btn">
            <i class="fas fa-times"></i> Close
        </button>
    </div>
</div>
