<div class="token-replacement-dialog">
    {{!-- Unified Header --}}
    {{> "partial-unified-header" 
        diceIcon="fas fa-images"
        mainTitle="Token Image Replacement"
        subtitle="Replace Token Images • Browse Matches • Manual Selection"
        rollMode="roll"
        dcValue=""
        isReadOnly=true
        showToggles=false
    }}
    
    {{#if isScanning}}
    <div class="cpb-scan-progress">
        <div class="cpb-progress-header">
            <h3><i class="fas fa-sync-alt fa-spin"></i> Scanning Token Images...</h3>
        </div>
        <div class="cpb-progress-bar">
            <div class="cpb-progress-fill" style="width: {{#if scanTotal}}{{math scanProgress "*" 100 "/" scanTotal}}{{else}}0{{/if}}%"></div>
        </div>
        <div class="cpb-progress-text">
            {{#if scanTotal}}
                {{scanProgress}} of {{scanTotal}} files scanned
            {{else}}
                Initializing scan...
            {{/if}}
        </div>
    </div>
    {{/if}}
    
    <div class="cpb-dialog-content">
        <!-- Left Column -->
        <div class="cpb-dialog-column">
            <div class="cpb-column-header">
                <div class="cpb-header-left">
                    <i class="fas fa-user-circle"></i> Selected Token
                </div>
                <div class="cpb-header-right"></div>
            </div>

            {{#if selectedToken}}
                <div class="cpb-token-display">
                    <div class="cpb-token-preview">
                        <img src="{{selectedToken.texture.src}}" alt="{{selectedToken.name}}" class="cpb-token-image">
                    </div>
                    <div class="cpb-token-info">
                        <div class="cpb-token-name">{{selectedToken.name}}</div>
                        <div class="cpb-token-details">
                            <span class="cpb-token-type">{{selectedToken.actor.type}}</span>
                            {{#if selectedToken.actor.system.details.level}}
                                <span class="cpb-token-level">Level {{selectedToken.actor.system.details.level}}</span>
                            {{/if}}
                        </div>
                        <div class="cpb-token-current">
                            <small>Current: {{selectedToken.texture.src}}</small>
                        </div>
                    </div>
                </div>
            {{else}}
                <div class="cpb-no-token">
                    <div class="cpb-no-token-icon">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <div class="cpb-no-token-text">
                        <p>No token selected</p>
                        <p>Select a token on the canvas to view replacement options</p>
                    </div>
                    <button class="cpb-button cpb-button-primary token-select-btn">
                        <i class="fas fa-mouse-pointer"></i> Select Current Token
                    </button>
                </div>
            {{/if}}
        </div>

        <!-- Right Column -->
        <div class="cpb-dialog-column">
            <div class="cpb-column-header">
                <div class="cpb-header-left">
                    <i class="fas fa-images"></i> Image Matches
                </div>
                <div class="cpb-header-right">
                    <button class="cpb-button cpb-button-secondary refresh-cache-btn" title="Refresh Image Cache">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>

            {{#if hasMatches}}
                <div class="cpb-thumbnails-grid">
                    {{#each matches}}
                    <div class="cpb-thumbnail-item" data-image-path="{{fullPath}}" data-image-name="{{name}}">
                        <div class="cpb-thumbnail-image">
                            <img src="{{fullPath}}" alt="{{name}}" loading="lazy">
                            <div class="cpb-thumbnail-overlay">
                                <i class="fas fa-check"></i>
                            </div>
                        </div>
                        <div class="cpb-thumbnail-name">{{name}}</div>
                    </div>
                    {{/each}}
                </div>
            {{else}}
                <div class="cpb-no-matches">
                    <div class="cpb-no-matches-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="cpb-no-matches-text">
                        <p>No matches found for this token</p>
                        <p>Try refreshing the cache or selecting a different token</p>
                    </div>
                </div>
            {{/if}}
        </div>
    </div>
    
    <!-- Footer -->
    <div class="cpb-dialog-footer">
        <button class="cpb-button cpb-button-secondary close-btn">
            <i class="fas fa-times"></i> Close
        </button>
    </div>
</div>
