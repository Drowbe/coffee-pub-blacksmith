<div class="token-replacement-window">
    {{!-- Custom Header --}}
    <div class="tir-header">
        <div class="tir-header-content">
            <div class="tir-header-icon">
                {{#if selectedToken.name}}
                    <img src="{{selectedToken.document.texture.src}}" alt="{{selectedToken.name}}">
                {{else}}
                    <i class="fas fa-user-group-crown"></i>
                {{/if}}
            </div>
            <div class="tir-header-title">
                {{#if selectedToken.name}}
                    <div class="tir-main-title">{{selectedToken.name}}</div>
                    <div class="tir-subtitle">{{selectedToken.actor.name}}  •  {{selectedToken.actor.type}}  •  {{selectedToken.actor.system.details.type.value}}  •  {{selectedToken.actor.system.details.type.subtype}}</div>
                {{else}}
                    <div class="tir-main-title">No token selected</div>
                    <div class="tir-subtitle">Select a token on the canvas</div>
                {{/if}}
            </div>
            <div class="tir-header-controls"><span>{{cacheStatus}}</span></div>
        </div>
        <!-- SCANNING PROGRESS -->
        {{#if isScanning}}
            <!-- OVERALL PROGRESS -->
            <div class="tir-scan-progress progress-overall">
                <div class="tir-progress-bar">
                    <div class="tir-progress-fill" style="width: {{overallProgressPercentage}}%"></div>
                    <div class="tir-progress-text">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <span class="tir-progress-total">{{#if totalSteps}}Step {{overallProgress}} of {{totalSteps}}{{else}}Initializing...{{/if}}</span> | <span class="tir-progress-details">{{currentStepName}}</span>
                    </div>
                </div>
            </div>
            <!-- Current Step PROGRESS -->
            <div class="tir-scan-progress progress-current">
                <div class="tir-progress-bar">
                    <div class="tir-progress-fill" style="width: {{currentStepProgressPercentage}}%"></div>
                    <div class="tir-progress-text">
                        <i class="fas fa-image-user"></i>
                        {{#if currentPath}}<span class="tir-progress-details">{{currentPath}}</span>{{/if}}
                        <span class="tir-progress-total">{{#if currentStepTotal}}{{currentStepProgress}} of {{currentStepTotal}}{{else}}Initializing...{{/if}}</span>
                        {{#if currentFileName}} | <span class="tir-progress-file">{{currentFileName}}</span>{{/if}}
                    </div>
                </div>
            </div>
        {{/if}}

    </div>

    <!-- CONTENT -->
    <div class="tir-content">
        <!-- Search Spinner Overlay -->
        <div class="tir-search-spinner hidden">
            <div class="tir-spinner"></div>
        </div>

        <!-- Token Info Header -->
        <div class="tir-token-replacement-header-container">
            <div class="tir-token-replacement-header-left"><i class="fas fa-image"></i> Image Replacements</div>
            <div class="tir-token-replacement-header-right">
                <button class="button-delete-cache" data-tooltip="Delete Cache: This will completely remove all cached image data."><i class="fas fa-trash"></i> Delete Cache</button>
                <span class="button-divider">|</span>
                <button class="button-pause-cache" data-tooltip="Stop Image Scan: This will result in incomplete image lokups."><i class="fas fa-pause"></i> Pause Scan</button>
                <button class="button-scan-images" data-tooltip="Scan for Images: This will update the image cache with any new or changed images."><i class="fas fa-search"></i> Scan for Images</button>
                <span class="button-divider">|</span>
                <button class="refresh-detection-btn" data-tooltip="Refresh Token Detection"><i class="fas fa-sync-alt"></i> Refresh Token Detection</button>
            </div>
        </div>

        <!-- Manual Search Area -->
        <div class="tir-search-container">
            <div class="tir-search-input-container">
                <input type="text" class="tir-search-input" placeholder="Search for images..." value="">
            </div>
        </div>

        <!-- Results Summary & Filters -->
        <div class="tir-results-summary">
            <div class="tir-results-count">
                <i class="fas fa-images"></i>
                <span class="tir-results-text">
                    {{#if isSearching}}
                        <span id="tir-results-text-results" class="tir-results-text-results">{{currentResults}} of {{totalResults}} Found</span>  |  <span id="tir-results-text-status" class="tir-results-text-status"><i class="fas fa-sync-alt fa-spin"></i> Searching for more...</span>
                    {{else}}
                        <span id="tir-results-text-results" class="tir-results-text-results">{{currentResults}} of {{totalResults}} Found</span>  |  <span id="tir-results-text-status" class="tir-results-text-status">Complete</span>
                    {{/if}}
                </span>
            </div>
            <div class="tir-tag-filters">
                <span class="tir-filter-label">Tags:</span>
                <div class="tir-filter-tags">
                    {{#each aggregatedTags}}
                    <span class="tir-filter-tag" data-search-term="{{this}}">{{this}}</span>
                    {{/each}}
                </div>
            </div>
        </div>

        <!-- Notification -->
        {{#if hasNotification}}
        <div class="tir-token-replacement-notification-container">
            <i class="{{notificationIcon}}"></i> {{notificationText}}
        </div>
        {{/if}}

        <!-- Image Grid -->
        <div class="tir-thumbnails-grid">
        {{#if selectedToken}}
            
            
            {{#if hasMatches}}
                {{#each matches}}
                <div class="tir-thumbnail-item {{#if isCurrent}}tir-current-image{{/if}}" data-image-path="{{fullPath}}" datatooltip="{{fullPath}}" data-image-name="{{name}}">
                    <div class="tir-thumbnail-image">
                        <!-- Image -->
                        <img src="{{fullPath}}" alt="{{name}}" loading="lazy">
                        <!-- Current Badge -->
                        {{#if isCurrent}}
                        <div class="tir-thumbnail-current-badge">
                            <i class="fas fa-check"></i>
                        </div>
                        {{else}}
                        <div class="tir-thumbnail-overlay">
                            <i class="fas fa-check"></i>
                        </div>
                        {{/if}}
                    </div>
                    <!-- Filename-->
                    <div class="tir-thumbnail-name">{{name}}</div>
                    <div class="tir-thumbnail-tagset">
                        {{#if isCurrent}}
                        <span class="tir-thumbnail-tag">CURRENT IMAGE</span>
                        {{else}}
                        <span class="tir-thumbnail-tag">tage here</span>
                        {{/if}}
                    </div>
                </div>
                {{/each}}
            {{else}}
                <!-- Show current token image even when no matches -->
                {{#if selectedToken.document.texture.src}}
                <div class="tir-thumbnail-item tir-current-image" data-image-path="{{selectedToken.document.texture.src}}" datatooltip="{{selectedToken.document.texture.src}}" data-image-name="Current Image">
                    <!-- Image -->
                    <div class="tir-thumbnail-image">
                        <img src="{{selectedToken.document.texture.src}}" alt="Current Image" loading="lazy">
                        <div class="tir-thumbnail-current-badge">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                    <!-- Filename-->
                    <div class="tir-thumbnail-name">{{selectedToken.document.texture.src}}</div>
                    <!-- Tags -->
                    <div class="tir-thumbnail-tagset"><span class="tir-thumbnail-tag">CURRENT IMAGE</span></div>
                </div>
                {{/if}}
                <!-- Show "No Matches" message -->
                <div class="tir-thumbnail-item tir-no-matches">
                    <!-- Image -->
                    <div class="tir-no-matches-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <!-- Description -->
                    <div class="tir-no-matches-text">
                        <p>No alternative images found for this token</p>
                        <p><span class="tir-thumbnail-tag">NO MATCHES</span></p>
                    </div>
                </div>
            {{/if}}
        {{else}}
            <!-- Show "No Matches" message -->
            <div class="tir-thumbnail-item tir-no-token">
                <!-- Image -->
                <div class="tir-no-token-icon">
                    <i class="fas fa-user-group-crown"></i>
                </div>
                <!-- Description -->
                <div class="tir-no-matches-text">
                    <p>Select a token to replace its image.</p>
                    <p><span class="tir-thumbnail-tag">NO TOKEN</span></p>
                </div>
            </div>
            
        {{/if}}

        </div>
        
        <!-- Loading Indicator -->
        {{#if isLoadingMore}}
        <div class="tir-loading-indicator">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Loading more results...</span>
        </div>
        {{/if}}
    </div>
</div>
