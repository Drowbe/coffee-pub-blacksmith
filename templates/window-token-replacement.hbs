<div class="token-replacement-window">
    {{!-- Global Controls (apply to both Token and Portrait modes) --}}
    <div class="tir-global-controls">
        {{#if portraitEnabled}}
        <!-- Mode Toggle (Token/Portrait) -->
        <div class="tir-toggle-container tir-mode-toggle">
            <span class="tir-toggle-label-left">Tokens</span>
            <div class="tir-toggle">
                <input type="checkbox" name="modeToggle" id="modeToggle" {{#if isPortraitMode}}checked{{/if}}>
                <label for="modeToggle" class="tir-toggle-slider"></label>
            </div>
            <span class="tir-toggle-label-right">Portraits</span>
        </div>
        {{/if}}
        <div class="tir-global-controls-right">
            {{#if itemPilesInstalled}}
            <!-- Loot Piles Toggle -->
            <div class="tir-toggle-container">
                <span class="tir-toggle-label">Loot Piles</span>
                <div class="tir-toggle">
                    <input type="checkbox" name="convertDeadToLoot" id="convertDeadToLoot" {{#if convertDeadToLoot}}checked{{/if}}>
                    <label for="convertDeadToLoot" class="tir-toggle-slider"></label>
                </div>
            </div>
            {{/if}}
            <!-- Convert Dead Toggle -->
            <div class="tir-toggle-container">
                <span class="tir-toggle-label">Convert Dead</span>
                <div class="tir-toggle">
                    <input type="checkbox" name="deadTokenReplacement" id="deadTokenReplacement" {{#if deadTokenReplacement}}checked{{/if}}>
                    <label for="deadTokenReplacement" class="tir-toggle-slider"></label>
                </div>
            </div>
        </div>
    </div>
    {{!-- Custom Header --}}
    <div class="tir-header">
        <div class="tir-header-content">
            <div class="tir-header-icon">
                {{#if selectedToken.name}}
                    <img src="{{selectedToken.document.texture.src}}" alt="{{selectedToken.name}}">
                {{else}}
                    <i class="fas fa-user-group-crown"></i>
                {{/if}}
            </div>
            <div class="tir-header-title">
                {{#if selectedToken.name}}
                    <div class="tir-main-title">{{selectedToken.name}}</div>
                    <div class="tir-subtitle">
                        {{#if selectedToken.actor.name}}{{selectedToken.actor.name}}{{/if}}
                        {{#if selectedToken.actor.type}}  •  {{selectedToken.actor.type}}{{/if}}
                        {{#if selectedToken.actor.system.details.type.value}}  •  {{selectedToken.actor.system.details.type.value}}{{/if}}
                        {{#if selectedToken.actor.system.details.type.subtype}}  •  {{selectedToken.actor.system.details.type.subtype}}{{/if}}
                    </div>
                {{else}}
                    <div class="tir-main-title">{{#if isPortraitMode}}No Actor{{else}}No Token{{/if}}</div>
                    <div class="tir-subtitle">{{#if isPortraitMode}}Select a token{{else}}Select a token{{/if}}</div>
                {{/if}}
            </div>
            <div class="tir-header-controls">
                <!-- Threshold Slider -->
                <div class="tir-rangeslider-container">
                    <span class="tir-rangeslider-label">Matching Threshold <span class="tir-threshold-value">30%</span></span>
                    <div class="tir-rangeslider">
                        <input type="range" name="searchThreshold" id="searchThreshold" min="0" max="100" value="30" class="tir-rangeslider-input">
                        <div class="tir-rangeslider-track">
                            <div class="tir-rangeslider-fill"></div>
                            <div class="tir-rangeslider-thumb"></div>
                        </div>
                        <span class="tir-rangeslider-value" style="display: none;">30%</span>
                    </div>
                </div>
                <!-- Fuzzy Search Toggle -->
                <div class="tir-toggle-container">
                    <span class="tir-toggle-label">Fuzzy Search</span>
                    <div class="tir-toggle">
                        <input type="checkbox" name="fuzzySearch" id="fuzzySearch" {{#if fuzzySearch}}checked{{/if}}>
                        <label for="fuzzySearch" class="tir-toggle-slider"></label>
                    </div>
                </div>
                <!-- Update Dropped Tokens/Portraits Toggle -->
                <div class="tir-toggle-container">
                    <span class="tir-toggle-label">Update Dropped {{#if isPortraitMode}}Portraits{{else}}Tokens{{/if}}</span>
                    <div class="tir-toggle">
                        <input type="checkbox" name="updateDropped" id="updateDropped" {{#if updateDropped}}checked{{/if}}>
                        <label for="updateDropped" class="tir-toggle-slider"></label>
                    </div>
                </div>


            </div>
        </div>
        <!-- SCANNING PROGRESS -->
        {{#if isScanning}}
            <!-- OVERALL PROGRESS -->
            <div class="tir-scan-progress progress-overall">
                <div class="tir-progress-bar">
                    <div class="tir-progress-fill" style="width: {{overallProgressPercentage}}%"></div>
                    <div class="tir-progress-text">
                        <i class="fas fa-sync-alt fa-spin"></i>
                        <span class="tir-progress-total">{{#if totalSteps}}{{#if showFolderInfo}}Folder {{currentFolderIndex}} of {{totalFolders}} | {{/if}}Phase {{overallProgress}} of {{totalSteps}}{{else}}Initializing...{{/if}}</span> | <span class="tir-progress-details">{{currentStepName}}</span>
                    </div>
                </div>
            </div>
            <!-- Current Step PROGRESS -->
            <div class="tir-scan-progress progress-current">
                <div class="tir-progress-bar">
                    <div class="tir-progress-fill" style="width: {{currentStepProgressPercentage}}%"></div>
                    <div class="tir-progress-text">
                        <i class="fas fa-image-user"></i>
                        {{#if currentPath}}<span class="tir-progress-details">{{currentPath}}</span>{{/if}}
                        <span class="tir-progress-total">{{#if currentStepTotal}}{{currentStepProgress}} of {{currentStepTotal}}{{else}}Initializing...{{/if}}</span>
                        {{#if currentFileName}} | <span class="tir-progress-file">{{currentFileName}}</span>{{/if}}
                    </div>
                </div>
            </div>
        {{/if}}

    </div>

    <!-- Token Info Header -->
    <div class="tir-token-replacement-header-container">
        <div class="tir-token-replacement-header-left"><i class="fas fa-search"></i> Search Filters</div>
        <div class="tir-token-replacement-header-right">

            <!-- DELETE CACHE -->
            <button class="button-delete-cache" data-tooltip="Delete Cache: This will completely remove all cached image data."><i class="fas fa-trash"></i> Delete Cache</button>

            <span class="button-divider"> • </span>

            <!-- SCAN FOR IMAGES -->
            {{#if isScanning}}
                <button class="button-pause-cache" data-tooltip="Stop Image Scan: This will result in incomplete image lokups."><i class="fas fa-pause"></i> Delay Scan</span></button>
            {{else}}
                <button class="button-scan-images" data-tooltip="Scan for Images: This will update the image cache with any new or changed images."><i class="fas fa-search"></i> Scan for Images</button>
            {{/if}}

            <span class="button-divider"> | </span>

            <!-- UPDATE CANVAS -->
            <button class="button-update-canvas" data-tooltip="Update Canvas: Re-run token/portrait replacements for every token on the current canvas using the active mode."><i class="fas fa-sync"></i> Update Canvas</button>

        </div>
    </div>

    <!-- Results Summary & Filters -->
    <div class="tir-search-tools-container">

        <!-- Row 1: Filters (left) and Result Counts (right) -->
        <div class="tir-search-tools-row-container row-category row-style-{{categoryStyle}}">
            <!-- Filters -->
            <div id="tir-filter-category-container" class="tir-search-tools-row-left">
                <span class="tir-filter-category row-style-{{categoryStyle}}" data-category="favorites"><i class="fas fa-heart"></i></span>
                <span class="tir-filter-category {{#if selectedToken}}active{{/if}} category-selected row-style-{{categoryStyle}}" data-category="selected">Selected</span>
                <span class="tir-filter-category {{#unless selectedToken}}active{{/unless}} row-style-{{categoryStyle}}" data-category="all">All</span>
                {{#each categories}}
                    <span class="tir-filter-category {{#if isActive}}active{{/if}} row-style-{{../categoryStyle}}" data-tooltip="{{name}} ({{count}})" data-category="{{key}}">{{name}}</span>
                {{/each}}
            </div>
            <!-- Actions -->
            <div class="tir-search-tools-row-right">
                <!-- Future Actions Here -->
                <span>{{cacheStatus}}</span>
            </div>
        </div>

        <!-- Row 2: Search Area and Results Counts -->
        <div class="tir-search-tools-row-container row-search">
            <div id="tir-search-tools-row-left" class="tir-search-tools-row-left">
                <div class="tir-search-container">
                    <input type="text" class="tir-search-input" placeholder="Search for images..." value="">
                    <button type="button" class="tir-clear-search-btn" title="Clear search">
                        <i class="fas fa-square-xmark"></i>
                    </button>
                </div>
                <button type="button" class="tir-filter-toggle-btn" title="Tag Sort: Count" data-tag-sort-mode="count">
                    <i class="fas fa-filter"></i>
                </button>
            </div>
            <div id="tir-search-tools-row-right" class="tir-search-tools-row-right tir-results-details">
                <!-- These results get dynamically overridden in token-image-replacement.js -->
                <span id="tir-results-details-count" class="tir-results-details-count"><i class="fas fa-images"></i>0 of 0 Showing</span>
                <span class="tir-results-details-divider">|</span>
                <span id="tir-results-details-status" class="tir-results-details-status"><i class="fas fa-check"></i>Complete</span>
            </div>
        </div>

        <!-- Row 3: Tags (only if tags exist) -->
        {{#if hasAggregatedTags}}
        <div id="tir-search-tools-tag-container" class="tir-search-tools-tag-container">
            {{#if aggregatedTags.primary.length}}
            <div class="tir-search-tools-tag-group tir-search-tools-tag-group-primary">
                <div class="tir-search-tools-tag-group-label">Primary Tags</div>
                <div class="tir-search-tools-tag-row">
                    {{#each aggregatedTags.primary}}
                    <span class="tir-search-tools-tag" data-search-term="{{this}}">{{this}}</span>
                    {{/each}}
                </div>
            </div>
            {{/if}}
            {{#if aggregatedTags.secondary.length}}
            <div class="tir-search-tools-tag-group tir-search-tools-tag-group-secondary">
                <div class="tir-search-tools-tag-group-label">Secondary Tags</div>
                <div class="tir-search-tools-tag-row">
                    {{#each aggregatedTags.secondary}}
                    <span class="tir-search-tools-tag" data-search-term="{{this}}">{{this}}</span>
                    {{/each}}
                </div>
            </div>
            {{/if}}
        </div>
        {{/if}}
    </div>



    <!-- Token Info Header -->
    <div class="tir-token-replacement-header-container">
        <!-- Title -->
        <div class="tir-token-replacement-header-left"><i class="fas fa-images"></i> Matching Results</div>
        <!-- Actions -->
        <div class="tir-token-replacement-header-right">
            <!-- Sort Order Selector -->
            <div class="cpb-form-group">
                <div class="tir-form-fields">
                    <select name="sortOrder" class="tir-select">
                        <option value="relevance" {{#if (eq sortOrder "relevance")}}selected{{/if}}>Sort by Relevance</option>
                        <option value="atoz" {{#if (eq sortOrder "atoz")}}selected{{/if}}>Alphabetical: A to Z</option>
                        <option value="ztoa" {{#if (eq sortOrder "ztoa")}}selected{{/if}}>Alphabetical: Z to A</option>
                    </select>
                </div>
            </div>
        </div>
    </div>


    <!-- CONTENT -->
    <div class="tir-content">
        <!-- Search Spinner Overlay -->
        <div class="tir-search-spinner hidden">
            <div class="tir-spinner"></div>
        </div>

        <!-- Notification -->
        {{#if hasNotification}}
        <div class="tir-token-replacement-notification-container notification-type-information">
            <i class="{{notificationIcon}}"></i> {{notificationText}}
        </div>
        {{/if}}

        <!-- Image Grid -->
        <div class="tir-thumbnails-grid">


            <!-- 
            ===============================================
            ALL RESULTS PROCESSING IS IN token-image-replacement.js TO SUPPORT PROCESSING SPEED

            See these Sections in _renderResults:
                BUILD: MATCHING RESULT
                BUILD: NO MATCHING RESULTS
                BUILD: NO TOKEN SELECTED
            ===============================================
            -->

        </div>
        
        <!-- Loading Indicator -->
        {{#if isLoadingMore}}
        <div class="tir-loading-indicator">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Loading more results...</span>
        </div>
        {{/if}}
    </div>
</div>
