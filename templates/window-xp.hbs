{{!-- XP Distribution Window Template --}}
<div class="xp-distribution foundry-style-window">
  <div class="xp-header-sticky">

    {{!-- Header --}}
    <div class="xp-distribution-header">
        <div class="xp-distribution-header-content">
            <div class="xp-distribution-header-icon">
              <i class="fas fa-swords"></i>
            </div>
            <div class="xp-distribution-header-title">
              <div class="xp-distribution-maintitle">Experience Distribution</div>
              <div class="xp-distribution-subtitle">Allocate Experience Points and Rewards to Party Members</div>
            </div>
            <div class="xp-distribution-header-controls">
                <!-- Experience Points Toggle -->
                <div class="xp-distribution-toggle-container">
                    <span class="xp-distribution-toggle-label">Experience Points</span>
                    <div class="xp-distribution-toggle">
                        <input type="checkbox" name="modeExperiencePoints" id="modeExperiencePoints" {{#if modeExperiencePoints}}checked{{/if}}>
                        <label for="modeExperiencePoints" class="xp-distribution-toggle-slider"></label>
                    </div>
                </div>
                <!-- Milestones Toggle -->
                <div class="xp-distribution-toggle-container">
                    <span class="xp-distribution-toggle-label">Milestones</span>
                    <div class="xp-distribution-toggle">
                        <input type="checkbox" name="modeMilestone" id="modeMilestone" {{#if modeMilestone}}checked{{/if}}>
                        <label for="modeMilestone" class="xp-distribution-toggle-slider"></label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{!-- Summary --}}
    <div class="xp-summary-row">
      <div class="xp-summary-item"><span class="label">Total XP</span><span>{{xpData.totalXp}}</span></div>
      <div class="xp-summary-item"><span class="label">Distribution Size</span><span>{{xpData.partySize}}</span></div>
      <div class="xp-summary-item"><span class="label">Multiplier</span><span>{{xpData.partyMultiplier}}x</span></div>
      <div class="xp-summary-item"><span class="label">Adjusted</span><span>{{xpData.adjustedTotalXp}}</span></div>
      <div class="xp-summary-item">
        <span class="label">Per Player</span>
        <span class="calculated-total" id="xp-total-display">{{xpData.xpPerPlayer}}</span>
      </div>
    </div>
  </div>

  {{!-- BODY - SCROLLABLE --}}
  <div class="xp-body-scroll">
    {{!-- Monster Resolutions Section - Show/hide with CSS class --}}
    <div class="xp-section {{#unless modeExperiencePoints}}hidden{{/unless}}" data-section="experience-points">
      <div class="xp-section-header"><i class="fas fa-dragon"></i> Monster Resolutions</div>
      <div class="xp-table-wrapper" data-table-type="monsters">
        <div class="xp-table-header">
          <span class="xp-table-col-1 xp-table-col-header">Adversary Name</span>
          <span class="xp-table-col-2 xp-table-col-header">CR</span>
          <span class="xp-table-col-3 xp-table-col-header">Resolution</span>
          <span class="xp-table-col-4 xp-table-col-header">Experience Points</span>
        </div>
        <div class="xp-table-body">
          {{#each xpData.monsters}}
          <div class="xp-table-row" data-row-type="monster" data-monster-id="{{id}}">
            <span class="xp-table-col-1" data-field="name">{{name}}</span>
            <span class="xp-table-col-2" data-field="cr">CR {{cr}}</span>
            <span class="xp-table-col-3" data-field="resolution">
              <span class="resolution-icons" role="group" aria-label="Monster Resolution">
                {{#each ../resolutionTypes}}
                <span class="resolution-icon {{#if (eq ../resolutionType this)}}active{{else}}dimmed{{/if}}"
                      data-monster-id="{{../id}}"
                      data-resolution="{{this}}"
                      data-tooltip="{{prettifyResolution this}}"
                      aria-label="{{prettifyResolution this}}"
                      tabindex="0">
                  {{#if (eq this "DEFEATED")}}<i class="fas fa-skull"></i>{{/if}}
                  {{#if (eq this "NEGOTIATED")}}<i class="fas fa-people-arrows"></i>{{/if}}
                  {{#if (eq this "ESCAPED")}}<i class="fas fa-running"></i>{{/if}}
                  {{#if (eq this "IGNORED")}}<i class="fas fa-person-walking-arrow-loop-left"></i>{{/if}}
                  {{#if (eq this "CAPTURED")}}<i class="fas fa-person-praying"></i>{{/if}}
                  {{#if (eq this "REMOVED")}}<i class="fas fa-person-circle-xmark"></i>{{/if}}
                </span>
                {{/each}}
              </span>
            </span>
            <span class="xp-table-col-4" data-field="xp">{{baseXp}} x {{formatMultiplier multiplier}} = {{finalXp}}</span>
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    {{!-- Milestones Section - Show/hide with CSS class --}}
    <div class="xp-section {{#unless modeMilestone}}hidden{{/unless}}" data-section="milestones">
      <div class="xp-section-header"><i class="fas fa-star"></i> Milestones</div>
      <div class="milestone-form">
        <div class="milestone-field-group">
          {{!-- Experience Points and Category side by side --}}
          <div class="milestone-row">
            <div class="milestone-field">
              <label class="label" for="milestone-xp">Experience Points</label>
              <input type="number" id="milestone-xp" name="milestone-xp" class="milestone-input" min="0" max="100000" placeholder="0">
            </div>
            <div class="milestone-field">
              <label class="label" for="milestone-category">Category</label>
              <select id="milestone-category" name="milestone-category" class="milestone-select">
                <option value="narrative">Narrative</option>
                <option value="quest">Quest</option>
                <option value="combat">Combat</option>
                <option value="discovery">Discovery</option>
                <option value="notable-moment">Notable Moment</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
        </div>
        <div class="milestone-field-group">
          <label for="milestone-title">Title</label>
          <input type="text" id="milestone-title" name="milestone-title" class="milestone-input" placeholder="Enter milestone title">
        </div>
        <div class="milestone-field-group">
          <label for="milestone-description">Description</label>
          <textarea id="milestone-description" name="milestone-description" class="milestone-textarea" placeholder="Description"></textarea>
        </div>
      </div>
    </div>

    {{!-- Player Adjustments Section - Always show --}}
    <div class="xp-section" data-section="player-adjustments">
      <div class="xp-section-header"><i class="fas fa-users"></i> Player Adjustments</div>
      
      <div class="xp-table-wrapper" data-table-type="players">
        <div class="xp-table-header">
          <span class="xp-table-col-1 xp-table-col-header">Party Member</span>
          <span class="xp-table-col-2 xp-table-col-header">Level</span>
          <span class="xp-table-col-3 xp-table-col-header">Experience Points</span>
        </div>
      
        <div class="xp-table-body">
          {{#each xpData.players}}
          <div class="xp-table-row" data-row-type="player" data-player-id="{{actorId}}">
            <span class="xp-table-col-1" data-field="name">
              <span class="inclusion-toggle active" data-player-id="{{actorId}}" tabindex="0">
                <i class="fas fa-swords"></i>
              </span>
              <img class="player-portrait" src="{{img}}" alt="{{name}}" />
              <span class="player-name">{{name}}</span>
            </span>

            <span class="xp-table-col-2" data-field="level">{{level}}</span>

            <span class="xp-table-col-3" data-field="xp">
              <span class="player-base-xp">{{../xpData.xpPerPlayer}}</span>
              <span class="adjustment-controls">
                <i class="fas fa-square-plus adjustment-sign active" data-sign="+"></i>
                <i class="fas fa-square-minus adjustment-sign" data-sign="-"></i>
                <input type="number" class="player-adjustment" name="player-adjustment-{{actorId}}" value="0" min="0" max="10000" placeholder="0">
              </span>
              <span class="equals">=</span>
              <span class="calculated-total">{{../xpData.xpPerPlayer}}</span>
            </span>
          </div>
          {{/each}}
        </div>
      </div>
    </div>

    {{!-- Resolution Types Section - Show/hide with CSS class --}}
    <div class="xp-section {{#unless modeExperiencePoints}}hidden{{/unless}}" data-section="resolution-types">
      <div class="xp-section-header"><i class="fas fa-info-circle"></i> Resolution Types</div>
      <div class="xp-legend-grid">
        {{#each legendTypes}}
        <div class="xp-legend-row">
          {{#if (eq key "DEFEATED")}}<i class="fas fa-skull"></i>{{/if}}
          {{#if (eq key "NEGOTIATED")}}<i class="fas fa-people-arrows"></i>{{/if}}
          {{#if (eq key "ESCAPED")}}<i class="fas fa-running"></i>{{/if}}
           {{#if (eq key "IGNORED")}}<i class="fas fa-person-walking-arrow-loop-left"></i>{{/if}}
           {{#if (eq key "CAPTURED")}}<i class="fas fa-person-praying"></i>{{/if}}
           {{#if (eq key "REMOVED")}}<i class="fas fa-person-circle-xmark"></i>{{/if}}
          <span class="legend-label">{{label}}:</span>
          <span class="legend-multiplier">{{formatMultiplier multiplier}} XP</span>
          <span class="legend-desc">{{desc}} </span>
        </div>
        {{/each}}
      </div>
    </div>
  </div>


  {{!-- Footer --}}
  <div class="xp-footer">
    <button type="button" class="xp-btn cancel-xp"><i class="fas fa-times"></i> Cancel Distribution</button>
    <button type="button" class="xp-btn apply-xp"><i class="fas fa-check"></i> Distribute XP to Party</button>
  </div>
</div>
