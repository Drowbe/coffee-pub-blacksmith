{{!-- Combat Tracker Secondary Bar --}}
<div class="combat-tracker-bar">
    {{!-- Combat Info --}}
    <div class="combat-info">
        <span class="combat-round">Combat Round {{currentRound}}</span>
        <span class="combat-turn">Turn {{currentTurn}} of {{totalTurns}}: {{currentCombatant}}</span>
    </div>
    
    {{!-- Combat Controls and Portraits Group --}}
    <div class="combat-portraits-group">

        {{#if isGM}}
        {{#if isActive}}
            <div class="combatbar-button-control-container">
            {{!-- Previous Round Button (GM Only, After Combat Started, Not Round 1) --}}
            {{#if (gt currentRound 1)}}
                <a class="combatbar-button" 
                aria-label="Previous Round" 
                role="button" 
                data-tooltip="Previous Round" 
                data-control="previousRound">
                    <i class="fas fa-chevrons-left"></i>
                </a>
            {{else}}
                    <span class="combatbar-button-disabled" data-tooltip="No Previous Round">
                        <i class="fas fa-chevrons-left"></i>
                    </span>
            {{/if}}
            {{!-- Previous Turn Button (GM Only, After Combat Started, Not Turn 1) --}}
            {{#if (gt currentTurn 1)}}
                <a class="combatbar-button" 
                aria-label="Previous Turn" 
                role="button" 
                data-tooltip="Previous Turn" 
                data-control="previousTurn">
                    <i class="fas fa-chevron-left"></i>
                </a>
            {{else}}
                <span class="combatbar-button-disabled" data-tooltip="No Previous Turn">
                    <i class="fas fa-chevron-left"></i>
                </span>
            {{/if}}

            </div>
        {{/if}}
        {{/if}}
        
        {{!-- Combat Portraits --}}
        <div class="combat-portraits">
        {{#each combatants}}
               <div class="combat-portrait-container {{#if isCurrent}}current{{/if}} {{#if isDefeated}}defeated{{/if}}"
                    data-combatant-id="{{id}}"
                    data-tooltip="{{name}} - Initiative: {{initiative}} - HP: {{currentHP}}/{{maxHP}}">
                   <div class="combat-portrait-healthring">
                       <svg width="{{svgSize}}" height="{{svgSize}}" viewBox="0 0 {{svgSize}} {{svgSize}}" class="{{healthClass}}">
                           <circle
                               cx="{{svgCenter}}"
                               cy="{{svgCenter}}"
                               r="{{svgRadius}}"
                               fill="none"
                               stroke-width="{{svgStrokeWidth}}"
                               stroke-dasharray="{{healthCircumference}}"
                               stroke-dashoffset="{{healthDashOffset}}"
                               transform="rotate(-90, {{svgCenter}}, {{svgCenter}})"
                               {{#if (gt currentHP 0)}}style="transition: stroke-dashoffset 0.3s ease-in-out, stroke 0.3s ease-in-out"{{/if}}
                           />
                       </svg>
                   </div>
                   <div class="combat-portrait-image">
                       <img src="{{portrait}}" alt="{{name}}" onerror="this.src='modules/coffee-pub-blacksmith/images/portraits/portrait-noimage.webp'">
                   </div>
                   
                   {{!-- Dead overlay - always show for defeated characters --}}
                   {{#if isDefeated}}
                   <div class="combat-portrait-dead-overlay" data-tooltip="Defeated">
                       <i class="fas fa-skull"></i>
                   </div>
                   {{/if}}
                   
                   {{!-- Initiative dice - only show for living characters that need initiative --}}
                   {{#if needsInitiative}}
                   {{#unless isDefeated}}
                   <div class="combat-portrait-initiative-dice {{#unless canRollInitiative}}waiting{{/unless}}">
                       {{#if canRollInitiative}}
                       <a class="combatant-control roll" 
                          aria-label="Roll Initiative" 
                          role="button" 
                          data-tooltip="COMBAT.InitiativeRoll" 
                          data-control="rollInitiative"
                          data-combatant-id="{{id}}">
                           <i class="fas fa-dice-d20"></i>
                       </a>
                       {{else}}
                       <span class="waiting-initiative" data-tooltip="Waiting for initiative">
                           <i class="fas fa-hourglass-half"></i>
                       </span>
                       {{/if}}
                   </div>
                   {{/unless}}
                   {{/if}}
               </div>
        {{/each}}
        </div>
        
        
        {{#if isGM}}
        {{#if isActive}}
        <div class="combatbar-button-control-container next-turn">
            {{!-- Next Turn Button (GM Only, After Combat Started) --}}
            <a class="combatbar-button" 
               aria-label="Next Turn" 
               role="button" 
               data-tooltip="Next Turn" 
               data-control="nextTurn">
                <i class="fas fa-chevron-right"></i>
            </a>
            {{!-- Next Round Button (GM Only, After Combat Started) --}}
            <a class="combatbar-button" 
               aria-label="Next Round" 
               role="button" 
               data-tooltip="Next Round" 
               data-control="nextRound">
                <i class="fas fa-chevrons-right"></i>
            </a>
        </div>
        {{/if}}
        {{/if}}
        
        {{!-- Action Button --}}
        {{#if actionButton}}
            <div class="combatbar-button-control-container action-button">
                <a class="combatbar-button  action-type-{{actionButton.type}}" 
                aria-label="{{actionButton.label}}" 
                role="button" 
                data-tooltip="{{actionButton.tooltip}}" 
                data-control="{{actionButton.control}}">
                    <i class="fas {{actionButton.icon}}"></i>
                    <span class="combatbar-button-label">{{actionButton.text}}</span>
                </a>
            </div>
        {{/if}}

    </div>

    {{!-- Combat Status --}}
    <div class="combat-status">
        <span class="combat-state">{{#if isActive}}Active Combat{{else}}Combat Pending{{/if}}</span>
    </div>
</div>
